@if(isGenerating()) {
<!-- Sticky Progress Header - Always Visible -->
<div
  class="fixed top-0 left-0 right-0 z-50 bg-gray-900/95 backdrop-blur-md border-b border-gray-700/50"
>
  <div class="max-w-7xl mx-auto px-6 py-4">
    <div class="flex items-center justify-between">
      <!-- Left: Status Info -->
      <div class="flex items-center space-x-4">
        <div
          class="w-12 h-12 bg-primary/5 rounded-full flex items-center justify-center"
        >
          <i class="pi pi-cog animate-spin text-xl text-white"></i>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-white">Génération en cours</h3>
          <p class="text-sm text-gray-400">
            {{ generationState().completedSteps }}/{{ generationState().totalSteps }} étapes terminées
          </p>
          @if (generationState().stepsInProgress.length > 0) {
          <p class="text-xs text-blue-400">
            En cours: {{ generationState().stepsInProgress.join(', ') }}
          </p>
          }
        </div>
      </div>

      <!-- Right: Progress Bar and Percentage -->
      <div class="flex items-center space-x-4 min-w-0 flex-1 max-w-md ml-8">
        <div class="flex-1">
          <p-progressBar
            [value]="progressPercentage()"
            [showValue]="false"
            styleClass="custom-progress-bar"
          ></p-progressBar>
          @if (generationState().stepsInProgress.length > 0) {
          <div class="mt-1 text-xs text-blue-400">
            {{ generationState().stepsInProgress[0] }}
          </div>
          }
        </div>
        <div class="text-right">
          <span class="text-2xl font-bold text-white"
            >{{ progressPercentage() }}%</span
          >
          <p class="text-xs text-gray-400">Terminé</p>
        </div>
      </div>

      <!-- Cancel Button -->
      <div class="ml-6">
        <p-button
          label="Annuler"
          icon="pi pi-times"
          severity="danger"
          size="small"
          (onClick)="cancelGeneration()"
          styleClass="cancel-button"
        ></p-button>
      </div>
    </div>
  </div>
</div>

<!-- Main Content with Top Padding -->
<div class="pt-32 min-h-screen">
  <div class="max-w-7xl mx-auto px-6 space-y-8">
    <!-- Current Step Section -->
    @if(currentStep()) {
    <div class="glass-card rounded-xl shadow-lg border border-gray-800/30">
      <div class="bg-gradient-to-r px-6 py-4 border-b">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center"
            >
              <i class="pi pi-spin pi-spinner text-white"></i>
            </div>
            <div>
              <h4 class="text-lg font-semibold text-blue-900">
                {{ currentStep()!.stepName }}
              </h4>
              <p class="text-sm text-blue-700">{{ currentStep()!.summary }}</p>
            </div>
          </div>
          <p-tag value="En cours" severity="info" icon="pi pi-clock"></p-tag>
        </div>
      </div>

      <!-- Skeleton Loaders for Content Being Generated -->
      <div class="p-6 space-y-4">
        <p-skeleton height="2rem" class="mb-3"></p-skeleton>
        <p-skeleton height="4rem" class="mb-3"></p-skeleton>
        <div class="grid grid-cols-2 gap-4">
          <p-skeleton height="3rem"></p-skeleton>
          <p-skeleton height="3rem"></p-skeleton>
        </div>
        <p-skeleton height="2rem" width="70%"></p-skeleton>
      </div>
    </div>
    }

    <!-- Completed Steps Section -->
    @if(hasCompletedSteps()) {
    <div class="space-y-6">
      <div class="grid gap-6">
        @for (step of completedSteps(); track step.stepName) {
        <div
          class="glass-card rounded-xl shadow-md border border-gray-800/30 overflow-hidden"
        >
          <div class="px-6 py-4 border-b">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div
                  class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center"
                >
                  <i class="pi pi-check text-white text-sm"></i>
                </div>
                <div>
                  <h4 class="text-lg font-semibold text-green-900">
                    {{ step.stepName }}
                  </h4>
                  <p class="text-sm text-green-700">{{ step.summary }}</p>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <p-tag
                  [value]="(step.timestamp | date:'HH:mm:ss') || 'N/A'"
                  severity="success"
                  icon="pi pi-clock"
                ></p-tag>
              </div>
            </div>
          </div>

          @if(step.content && step.content !== 'step_started') {
          <div class="p-6">
            <div class="prose max-w-none">
              <markdown mermaid [data]="step.content"></markdown>
            </div>
          </div>
          }
        </div>
        }
      </div>
    </div>
    }
  </div>
</div>

} @else if(generationError()) {
<!-- Error State -->
<div class="min-h-screen flex items-center justify-center">
  <div class="max-w-md mx-auto text-center">
    <div class="glass-card rounded-xl shadow-lg p-8">
      <div
        class="w-16 h-16 bg-red-100/5 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <svg
          class="w-8 h-8 text-red-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"
          ></path>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">
        Erreur de génération
      </h3>
      <p class="text-gray-600 mb-6">{{ generationError() }}</p>
      <p-button
        label="Réessayer"
        icon="pi pi-refresh"
        severity="danger"
        (onClick)="generateDiagrams()"
      ></p-button>
    </div>
  </div>
</div>

} @else {
<!-- Initial State -->
<div class="min-h-[80vh] flex items-center justify-center">
  <div class="max-w-2xl mx-auto text-center">
    <div class="glass-card rounded-xl shadow-lg p-12">
      <div
        class="w-20 h-20 bg-blue-800/5 rounded-full flex items-center justify-center mx-auto mb-6"
      >
        <svg
          class="w-10 h-10 text-blue-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
          ></path>
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-white mb-4">No diagrams found</h3>
      <p class="text-gray-600 mb-8">
        Start by generating your first diagrams to visualize your architecture.
      </p>
      <button (click)="generateDiagrams()" class="w-full inner-button">
        Generate Diagrams
      </button>
    </div>
  </div>
</div>
}
