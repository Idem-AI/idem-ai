<div class="tfvars-form-editor h-full flex flex-col p-4">
  @if (hasData()) {
  <!-- Form Header -->
  <div class="flex-shrink-0 glass-card p-4 mb-4">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-white text-glow-primary">
        Terraform Variables
      </h3>
      <p-button
        label="Add Variable"
        icon="pi pi-plus"
        size="small"
        (onClick)="startAddingCustomField()"
        [disabled]="readonlySignal() || isAddingCustomField()"
        pTooltip="Add a new custom variable"
        tooltipPosition="left"
      ></p-button>
    </div>
  </div>

  <!-- Form Content -->
  <div class="flex-1 overflow-y-auto space-y-6 p-4">
    <form [formGroup]="mainForm()" class="space-y-6">
      <!-- Sections using PrimeNG Accordion -->
      <p-accordion [multiple]="true" [className]="'bg-red-500'">
        @for (section of sectionsWithData(); track trackSection($index,
        section)) {
        <p-accordion-panel [value]="$index.toString()">
          <p-accordion-header>
            <div class="flex items-center">
              <h4 class="text-lg font-medium text-white text-glow-primary">
                {{ section.name }}
              </h4>
              @if (section.description) {
              <p-tag
                [value]="section.description"
                severity="info"
                class="ml-3"
              ></p-tag>
              }
            </div>
          </p-accordion-header>

          <p-accordion-content>
            <div class="space-y-4 p-4" [formGroupName]="section.name">
              @for (field of section.fields; track trackField($index, field)) {
              <div class="space-y-2 mx-4">
                <!-- Field Input with PrimeNG -->
                <div class="space-y-2">
                  @switch (field.type) { @case ('text') {
                  <p-floatlabel>
                    <input
                      pInputText
                      [id]="section.name + '_' + field.key"
                      [formControlName]="field.key"
                      [readonly]="readonlySignal()"
                      class="input w-full"
                    />
                    <label [for]="section.name + '_' + field.key">
                      {{ field.label }}
                    </label>
                  </p-floatlabel>
                  } @case ('textarea') {
                  <p-floatlabel>
                    <textarea
                      pTextarea
                      [id]="section.name + '_' + field.key"
                      [formControlName]="field.key"
                      [readonly]="readonlySignal()"
                      rows="3"
                      class="input w-full"
                    ></textarea>
                    <label [for]="section.name + '_' + field.key">
                      {{ field.label }}
                    </label>
                  </p-floatlabel>
                  } @case ('number') {
                  <p-floatlabel>
                    <p-inputnumber
                      [id]="section.name + '_' + field.key"
                      [formControlName]="field.key"
                      [readonly]="readonlySignal()"
                      class="input w-full"
                    ></p-inputnumber>
                    <label [for]="section.name + '_' + field.key">
                      {{ field.label }}
                    </label>
                  </p-floatlabel>
                  } @case ('boolean') {
                  <div class="flex items-center space-x-3">
                    <p-toggleswitch
                      [id]="section.name + '_' + field.key"
                      [formControlName]="field.key"
                      [disabled]="readonlySignal()"
                    ></p-toggleswitch>
                    <label
                      [for]="section.name + '_' + field.key"
                      class="text-sm text-white"
                    >
                      {{ field.label }}
                    </label>
                  </div>
                  } @case ('array') {
                  <div class="space-y-2">
                    @for (item of getFieldControl(section.name,
                    field.key)?.value || []; track trackArrayItem($index, item))
                    {
                    <div class="flex items-center space-x-2">
                      <input
                        pInputText
                        [value]="item"
                        (input)="updateArrayItem(section.name, field.key, $index, $any($event).target.value)"
                        [readonly]="readonlySignal()"
                        [placeholder]="'Item ' + ($index + 1)"
                        class="input flex-1"
                      />
                      @if (!readonlySignal()) {
                      <p-button
                        icon="pi pi-times"
                        size="small"
                        severity="danger"
                        [text]="true"
                        (onClick)="removeArrayItem(section.name, field.key, $index)"
                      ></p-button>
                      }
                    </div>
                    } @if (!readonlySignal()) {
                    <p-button
                      label="Add Item"
                      icon="pi pi-plus"
                      size="small"
                      severity="secondary"
                      [text]="true"
                      (onClick)="addArrayItem(section.name, field.key)"
                    ></p-button>
                    }
                  </div>
                  } @case ('object') {
                  <p-floatlabel>
                    <textarea
                      pTextarea
                      [id]="section.name + '_' + field.key"
                      [value]="getFieldControl(section.name, field.key)?.value | json"
                      [readonly]="readonlySignal()"
                      (input)="onObjectInputChange(section.name, field.key, $any($event).target.value)"
                      rows="4"
                      class="input w-full font-mono"
                    ></textarea>
                    <label [for]="section.name + '_' + field.key">
                      {{ field.label }} (JSON)
                    </label>
                  </p-floatlabel>
                  } }

                  <!-- Field Error -->
                  @if (getFieldError(section.name, field.key)) {
                  <p-message
                    severity="error"
                    [text]="getFieldError(section.name, field.key)!"
                    class="mt-1"
                  ></p-message>
                  }
                </div>
              </div>
              }
            </div>
          </p-accordion-content>
        </p-accordion-panel>
        }
      </p-accordion>

      <!-- Custom Fields Section -->
      @if (formDataSignal()?.customFields &&
      formDataSignal()!.customFields.length > 0) {
      <p-accordion [multiple]="true" class="glass-card">
        <p-accordion-panel value="custom">
          <p-accordion-header>
            <div class="flex items-center">
              <h4 class="text-lg font-medium text-white text-glow-primary">
                Custom Variables
              </h4>
              <p-tag
                [value]="(formDataSignal()!.customFields.length || 0) + ' variables'"
                severity="info"
                class="ml-3"
              ></p-tag>
            </div>
          </p-accordion-header>

          <p-accordion-content>
            <div class="space-y-4 p-4" formGroupName="custom">
              @for (field of formDataSignal()!.customFields; track
              trackField($index, field)) {
              <div class="space-y-2">
                <div class="flex items-center justify-between mb-2">
                  <label class="block text-sm font-medium text-white">
                    {{ formatLabel(field.label) }} @if (field.required) {
                    <span class="text-red-400 ml-1">*</span>
                    }
                  </label>
                  @if (!readonlySignal()) {
                  <p-button
                    icon="pi pi-times"
                    size="small"
                    severity="danger"
                    [text]="true"
                    (onClick)="removeFieldFromSection('custom', field.key)"
                    pTooltip="Remove field"
                  ></p-button>
                  }
                </div>

                @if (field.description) {
                <p class="text-xs text-gray-400 mb-2">
                  {{ field.description }}
                </p>
                }

                <div class="space-y-2">
                  @switch (field.type) { @case ('text') {
                  <p-floatlabel>
                    <input
                      pInputText
                      [id]="'custom_' + field.key"
                      [formControlName]="field.key"
                      [readonly]="readonlySignal()"
                      class="input w-full"
                    />
                    <label [for]="'custom_' + field.key"
                      >{{ field.label }}</label
                    >
                  </p-floatlabel>
                  } @case ('textarea') {
                  <p-floatlabel>
                    <textarea
                      pTextarea
                      [id]="'custom_' + field.key"
                      [formControlName]="field.key"
                      [readonly]="readonlySignal()"
                      rows="3"
                      class="input w-full"
                    ></textarea>
                    <label [for]="'custom_' + field.key"
                      >{{ field.label }}</label
                    >
                  </p-floatlabel>
                  } @case ('number') {
                  <p-floatlabel>
                    <p-inputnumber
                      [id]="'custom_' + field.key"
                      [formControlName]="field.key"
                      [readonly]="readonlySignal()"
                      class="input w-full"
                    ></p-inputnumber>
                    <label [for]="'custom_' + field.key"
                      >{{ field.label }}</label
                    >
                  </p-floatlabel>
                  } @case ('boolean') {
                  <div class="flex items-center space-x-3">
                    <p-toggleswitch
                      [id]="'custom_' + field.key"
                      [formControlName]="field.key"
                      [disabled]="readonlySignal()"
                    ></p-toggleswitch>
                    <label
                      [for]="'custom_' + field.key"
                      class="text-sm text-white"
                    >
                      {{ field.label }}
                    </label>
                  </div>
                  } @case ('array') {
                  <div class="space-y-2">
                    @for (item of getFieldControl('custom', field.key)?.value ||
                    []; track trackArrayItem($index, item)) {
                    <div class="flex items-center space-x-2">
                      <input
                        pInputText
                        [value]="item"
                        (input)="updateArrayItem('custom', field.key, $index, $any($event).target.value)"
                        [readonly]="readonlySignal()"
                        [placeholder]="'Item ' + ($index + 1)"
                        class="input flex-1"
                      />
                      @if (!readonlySignal()) {
                      <p-button
                        icon="pi pi-times"
                        size="small"
                        severity="danger"
                        [text]="true"
                        (onClick)="removeArrayItem('custom', field.key, $index)"
                      ></p-button>
                      }
                    </div>
                    } @if (!readonlySignal()) {
                    <p-button
                      label="Add Item"
                      icon="pi pi-plus"
                      size="small"
                      severity="secondary"
                      [text]="true"
                      (onClick)="addArrayItem('custom', field.key)"
                    ></p-button>
                    }
                  </div>
                  } @case ('object') {
                  <p-floatlabel>
                    <textarea
                      pTextarea
                      [id]="'custom_' + field.key"
                      [value]="getFieldControl('custom', field.key)?.value | json"
                      [readonly]="readonlySignal()"
                      (input)="onObjectInputChange('custom', field.key, $any($event).target.value)"
                      rows="4"
                      class="input w-full font-mono"
                    ></textarea>
                    <label [for]="'custom_' + field.key"
                      >{{ field.label }} (JSON)</label
                    >
                  </p-floatlabel>
                  } } @if (getFieldError('custom', field.key)) {
                  <p-message
                    severity="error"
                    [text]="getFieldError('custom', field.key)!"
                    class="mt-1"
                  ></p-message>
                  }
                </div>
              </div>
              }
            </div>
          </p-accordion-content>
        </p-accordion-panel>
      </p-accordion>
      }

      <!-- Add Custom Field Form -->
      @if (isAddingCustomField()) {
      <div
        class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-4"
      >
        <h4 class="text-sm font-medium text-blue-900 dark:text-blue-300 mb-4">
          Add Custom Variable
        </h4>

        <form [formGroup]="customFieldForm()" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="custom_key"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Variable Key *
              </label>
              <input
                type="text"
                id="custom_key"
                formControlName="key"
                placeholder="e.g., my_variable"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 sm:text-sm"
              />
              @if (customFieldForm().get('key')?.errors?.['required'] &&
              customFieldForm().get('key')?.touched) {
              <p class="mt-1 text-sm text-red-600 dark:text-red-400">
                Key is required
              </p>
              } @if (customFieldForm().get('key')?.errors?.['pattern'] &&
              customFieldForm().get('key')?.touched) {
              <p class="mt-1 text-sm text-red-600 dark:text-red-400">
                Key must be a valid identifier
              </p>
              }
            </div>

            <div>
              <label
                for="custom_type"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Type *
              </label>
              <select
                id="custom_type"
                formControlName="type"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 sm:text-sm"
              >
                <option value="text">Text</option>
                <option value="textarea">Textarea</option>
                <option value="number">Number</option>
                <option value="boolean">Boolean</option>
                <option value="array">Array</option>
                <option value="object">Object</option>
              </select>
            </div>
          </div>

          <div>
            <label
              for="custom_label"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Display Label
            </label>
            <input
              type="text"
              id="custom_label"
              formControlName="label"
              placeholder="Auto-generated from key if empty"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 sm:text-sm"
            />
          </div>

          <div>
            <label
              for="custom_description"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Description
            </label>
            <textarea
              id="custom_description"
              formControlName="description"
              rows="2"
              placeholder="Optional description for this variable"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 sm:text-sm"
            ></textarea>
          </div>

          <div class="flex items-center">
            <input
              type="checkbox"
              id="custom_required"
              formControlName="required"
              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded dark:border-gray-600 dark:bg-gray-700"
            />
            <label
              for="custom_required"
              class="ml-2 block text-sm text-gray-900 dark:text-gray-300"
            >
              Required field
            </label>
          </div>

          <div class="flex justify-end space-x-3">
            <button
              type="button"
              class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600"
              (click)="cancelAddingCustomField()"
            >
              Cancel
            </button>
            <button
              type="button"
              class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
              [disabled]="!customFieldForm().valid"
              (click)="saveCustomField()"
            >
              Add Variable
            </button>
          </div>
        </form>
      </div>
      }
    </form>
  </div>
  } @else {
  <!-- Empty State -->
  <div class="flex-1 flex items-center justify-center p-8">
    <div class="text-center">
      <svg
        class="mx-auto h-12 w-12 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
        ></path>
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">
        No variables found
      </h3>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        No Terraform variables are available for editing.
      </p>
    </div>
  </div>
  }
</div>
